name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: YourStrong!Passw0rd123
        ports:
          - 1433:1433

    env:
      APP_ENV: local
      APP_TIMEZONE: America/Sao_Paulo
      TZ: America/Sao_Paulo
      API_HTTP_PORT: "8000"

      SQLSERVER_HOST: localhost
      SQLSERVER_PORT: "1433"
      SQLSERVER_DATABASE: ProjetoMBras
      SQLSERVER_USER: sa
      SQLSERVER_PASSWORD: YourStrong!Passw0rd123
      SQLSERVER_ODBC_DRIVER: ODBC Driver 18 for SQL Server

      ENABLE_RABBIT: "0"
      RABBITMQ_URL: amqp://guest:guest@localhost:5672/
      RABBITMQ_EXCHANGE: api.events
      RABBITMQ_ROUTING_KEY_ANALYZE: mbras.analyze
      RABBITMQ_QUEUE_ANALYZE: mbras.analyze.queue

      ELASTICSEARCH_URL: http://localhost:9200
      ELASTICSEARCH_INDEX_PREFIX: projetombras-api-events
      KIBANA_URL: http://localhost:5601

      PROMETHEUS_METRICS_ENABLED: "true"
      DB_POOL_SIZE: "5"
      DB_MAX_OVERFLOW: "10"
      DB_POOL_TIMEOUT: "30"
      DB_POOL_RECYCLE: "1800"
      WORKER_RETRY_LIMIT: "5"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ODBC Driver 18 for SQL Server
        run: |
          sudo apt-get update
          sudo apt-get install -y curl gnupg2 apt-transport-https ca-certificates unixodbc-dev g++
          curl -sSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/22.04/prod jammy main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for SQL Server
        run: |
          python - <<'PY'
          import time
          import pyodbc

          conn_str = (
              "DRIVER={ODBC Driver 18 for SQL Server};"
              "SERVER=localhost,1433;"
              "DATABASE=master;"
              "UID=sa;"
              "PWD=YourStrong!Passw0rd123;"
              "TrustServerCertificate=yes;"
          )

          for attempt in range(1, 31):
              try:
                  with pyodbc.connect(conn_str, autocommit=True, timeout=3) as conn:
                      cur = conn.cursor()
                      cur.execute("SELECT 1")
                      cur.fetchone()
                  print("SQL Server pronto para uso.")
                  break
              except Exception:
                  if attempt == 30:
                      raise
                  time.sleep(2)
          PY

      - name: Bootstrap DB and run migrations
        run: python -m app.infrastructure.runtime.migrate

      - name: Run tests
        run: pytest -q
