name: CI

on:
  push:
  pull_request:

jobs:
  test:
    name: Test (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
    runs-on: ${{ matrix.os }}

    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: ChangeMe_StrongPassword123!
        ports:
          - 1434:1433

    env:
      APP_ENV: local
      APP_TIMEZONE: America/Sao_Paulo
      TZ: America/Sao_Paulo
      API_HTTP_PORT: "8000"

      SQLSERVER_HOST: localhost
      SQLSERVER_PORT: "1434"
      SQLSERVER_DATABASE: ProjetoMBras
      SQLSERVER_USER: sa
      SQLSERVER_PASSWORD: ChangeMe_StrongPassword123!
      SQLSERVER_ODBC_DRIVER: ODBC Driver 18 for SQL Server

      ENABLE_RABBIT: "0"
      RABBITMQ_URL: amqp://guest:guest@localhost:5672/
      RABBITMQ_EXCHANGE: api.events
      RABBITMQ_ROUTING_KEY_ANALYZE: mbras.analyze
      RABBITMQ_QUEUE_ANALYZE: mbras.analyze.queue

      ELASTICSEARCH_URL: http://localhost:9200
      ELASTICSEARCH_INDEX_PREFIX: projetombras-api-events
      KIBANA_URL: http://localhost:5601

      PROMETHEUS_METRICS_ENABLED: "true"
      DB_POOL_SIZE: "5"
      DB_MAX_OVERFLOW: "10"
      DB_POOL_TIMEOUT: "30"
      DB_POOL_RECYCLE: "1800"
      WORKER_RETRY_LIMIT: "5"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare .env for Docker Compose
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ODBC Driver 18 for SQL Server
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y curl gnupg2 apt-transport-https ca-certificates unixodbc-dev g++
          sudo rm -f /usr/share/keyrings/microsoft-prod.gpg
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor --batch --yes --no-tty -o /usr/share/keyrings/microsoft-prod.gpg
          source /etc/os-release
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-prod.gpg] https://packages.microsoft.com/ubuntu/${VERSION_ID}/prod ${VERSION_CODENAME} main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for SQL Server
        run: |
          python - <<'PY'
          import os
          import time
          import pyodbc

          conn_str = (
              "DRIVER={ODBC Driver 18 for SQL Server};"
              f"SERVER=localhost,{os.getenv('SQLSERVER_PORT', '1434')};"
              "DATABASE=master;"
              f"UID={os.getenv('SQLSERVER_USER', 'sa')};"
              f"PWD={os.getenv('SQLSERVER_PASSWORD', '')};"
              "TrustServerCertificate=yes;"
          )

          for attempt in range(1, 31):
              try:
                  with pyodbc.connect(conn_str, autocommit=True, timeout=3) as conn:
                      cur = conn.cursor()
                      cur.execute("SELECT 1")
                      cur.fetchone()
                  print("SQL Server pronto para uso.")
                  break
              except Exception:
                  if attempt == 30:
                      raise
                  time.sleep(2)
          PY

      - name: Rebuild and start containers (no cache)
        run: |
          docker compose down --remove-orphans
          docker compose pull --ignore-pull-failures
          docker compose build --no-cache
          docker compose up -d --force-recreate

      - name: Wait for API health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/health >/dev/null; then
              echo "API saudavel em http://localhost:8080/health"
              exit 0
            fi
            sleep 2
          done
          echo "API nao ficou saudavel a tempo"
          docker compose ps
          docker compose logs --tail=200 api worker outbox-publisher
          exit 1

      - name: Bootstrap DB and run migrations
        run: python -m app.infrastructure.runtime.migrate

      - name: Run tests
        run: pytest -q

      - name: Show container logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --tail=200

      - name: Tear down containers
        if: always()
        run: docker compose down --remove-orphans
